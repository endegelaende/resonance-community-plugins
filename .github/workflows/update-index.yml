# Update Index workflow for Resonance community plugins.
#
# Generates index.json by scanning all plugins/*/plugin.toml files
# and matching them with the latest GitHub Releases. The resulting
# index.json is deployed to GitHub Pages so that Resonance servers
# can fetch available community plugins.
#
# Triggered by:
#   - Completion of the build-release workflow
#   - Manual workflow_dispatch
#   - Weekly schedule (to catch any missed updates)

name: Update Index

on:
    workflow_dispatch:
    workflow_run:
        workflows: ["Build Plugin Release"]
        types:
            - completed
    schedule:
        # Weekly on Sunday at 03:00 UTC
        - cron: "0 3 * * 0"

permissions:
    contents: read
    pages: write
    id-token: write

concurrency:
    group: pages-deploy
    cancel-in-progress: true

jobs:
    build-index:
        name: Generate index.json
        runs-on: ubuntu-latest
        # Only run if the triggering workflow succeeded (or if manually dispatched / scheduled)
        if: >-
            github.event_name == 'workflow_dispatch' ||
            github.event_name == 'schedule' ||
            (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.12"

            - name: Generate index.json
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  python3 << 'PYEOF'
                  import json
                  import os
                  import subprocess
                  import sys
                  from datetime import datetime, timezone
                  from pathlib import Path

                  try:
                      import tomllib
                  except ImportError:
                      import tomli as tomllib


                  def parse_toml(path: Path) -> dict:
                      """Parse a plugin.toml file."""
                      with open(path, "rb") as f:
                          return tomllib.load(f)


                  def get_latest_release(plugin_name: str) -> dict | None:
                      """Get the latest GitHub release for a plugin using gh CLI."""
                      try:
                          result = subprocess.run(
                              [
                                  "gh", "release", "list",
                                  "--json", "tagName,assets,isDraft,isPrerelease",
                                  "--limit", "50",
                              ],
                              capture_output=True, text=True, check=True,
                          )
                          releases = json.loads(result.stdout)

                          # Find the latest release matching this plugin
                          prefix = f"{plugin_name}-v"
                          for release in releases:
                              tag = release.get("tagName", "")
                              if not tag.startswith(prefix):
                                  continue
                              if release.get("isDraft") or release.get("isPrerelease"):
                                  continue
                              return release
                      except (subprocess.CalledProcessError, json.JSONDecodeError) as exc:
                          print(f"  Warning: could not fetch releases: {exc}", file=sys.stderr)
                      return None


                  def get_release_assets(tag: str) -> list[dict]:
                      """Fetch full asset details for a release tag via gh release view."""
                      try:
                          result = subprocess.run(
                              ["gh", "release", "view", tag, "--json", "assets"],
                              capture_output=True, text=True, check=True,
                          )
                          data = json.loads(result.stdout)
                          return data.get("assets", [])
                      except (subprocess.CalledProcessError, json.JSONDecodeError) as exc:
                          print(f"  Warning: could not fetch assets for {tag}: {exc}", file=sys.stderr)
                          return []


                  def download_sha_file(tag: str, sha_filename: str) -> str:
                      """Download a .sha256 file from a release and return the checksum string."""
                      import tempfile
                      with tempfile.TemporaryDirectory() as tmpdir:
                          try:
                              subprocess.run(
                                  ["gh", "release", "download", tag,
                                   "--pattern", sha_filename,
                                   "--dir", tmpdir],
                                  capture_output=True, text=True, check=True,
                              )
                              sha_path = Path(tmpdir) / sha_filename
                              if sha_path.exists():
                                  content = sha_path.read_text().strip()
                                  # Format is either just the hash or "hash  filename"
                                  return content.split()[0] if content else ""
                          except subprocess.CalledProcessError as exc:
                              print(f"  Warning: could not download {sha_filename}: {exc}", file=sys.stderr)
                      return ""


                  def extract_release_info(plugin_name: str, release: dict) -> tuple[str, str, str]:
                      """Extract download URL, SHA-256, and version from a release."""
                      tag = release["tagName"]
                      version = tag.split("-v", 1)[1] if "-v" in tag else ""

                      # Fetch full asset details (with downloadUrl) via gh release view
                      assets = get_release_assets(tag)

                      zip_url = ""
                      sha256 = ""
                      sha_filename = ""

                      for asset in assets:
                          asset_name = asset.get("name", "")
                          # gh release view --json assets returns "url" as the browser
                          # download URL (not the API URL that gh release list returns)
                          asset_url = asset.get("url", "")

                          if asset_name.endswith(".zip") and not asset_name.endswith(".sha256"):
                              zip_url = asset_url
                          elif asset_name.endswith(".sha256"):
                              sha_filename = asset_name

                      # Download the .sha256 file separately to read the checksum
                      if sha_filename:
                          sha256 = download_sha_file(tag, sha_filename)

                      # Fallback: construct the expected download URL from the tag
                      if not zip_url and version:
                          repo = os.environ.get("GITHUB_REPOSITORY", "resonance-plugins/community")
                          zip_url = (
                              f"https://github.com/{repo}/releases/download/"
                              f"{tag}/{plugin_name}-{version}.zip"
                          )

                      return zip_url, sha256, version


                  def main():
                      plugins_dir = Path("plugins")
                      if not plugins_dir.is_dir():
                          print("Error: plugins/ directory not found", file=sys.stderr)
                          sys.exit(1)

                      repo = os.environ.get("GITHUB_REPOSITORY", "resonance-plugins/community")

                      plugins = []
                      plugin_dirs = sorted(p for p in plugins_dir.iterdir() if p.is_dir())

                      for plugin_path in plugin_dirs:
                          toml_path = plugin_path / "plugin.toml"
                          if not toml_path.exists():
                              print(f"  Skipping {plugin_path.name}: no plugin.toml")
                              continue

                          print(f"Processing plugin: {plugin_path.name}")

                          try:
                              data = parse_toml(toml_path)
                          except Exception as exc:
                              print(f"  Error parsing {toml_path}: {exc}", file=sys.stderr)
                              continue

                          plugin_meta = data.get("plugin", {})
                          name = plugin_meta.get("name", plugin_path.name)
                          toml_version = plugin_meta.get("version", "0.0.0")

                          # Try to find a matching GitHub release
                          release = get_latest_release(name)

                          if release:
                              zip_url, sha256, release_version = extract_release_info(name, release)
                              version = release_version or toml_version
                              print(f"  Found release: v{version}")
                          else:
                              zip_url = ""
                              sha256 = ""
                              version = toml_version
                              print(f"  No release found, using toml version: v{version}")

                          # If no release asset URL, construct the expected URL pattern
                          if not zip_url and version:
                              zip_url = (
                                  f"https://github.com/{repo}/releases/download/"
                                  f"{name}-v{version}/{name}-{version}.zip"
                              )

                          tags = plugin_meta.get("tags", [])
                          if isinstance(tags, str):
                              tags = [t.strip() for t in tags.split(",")]

                          entry = {
                              "name": name,
                              "version": version,
                              "description": plugin_meta.get("description", ""),
                              "author": plugin_meta.get("author", ""),
                              "category": plugin_meta.get("category", "misc"),
                              "icon": plugin_meta.get("icon", ""),
                              "min_resonance_version": plugin_meta.get("min_resonance_version", ""),
                              "url": zip_url,
                              "sha256": sha256,
                              "homepage": f"https://github.com/{repo}/tree/main/plugins/{name}",
                              "changelog": "",
                              "tags": tags,
                          }

                          # Only include plugins that have a download URL
                          if entry["url"]:
                              plugins.append(entry)
                              print(f"  Added to index: {name} v{version}")
                          else:
                              print(f"  Skipped (no download URL): {name}")

                      index = {
                          "version": 1,
                          "generated": datetime.now(timezone.utc).strftime("%Y-%m-%dT%H:%M:%SZ"),
                          "repository": f"https://github.com/{repo}",
                          "plugins": plugins,
                      }

                      # Write index.json
                      output_dir = Path("_site")
                      output_dir.mkdir(exist_ok=True)

                      index_path = output_dir / "index.json"
                      with open(index_path, "w", encoding="utf-8") as f:
                          json.dump(index, f, indent=2, ensure_ascii=False)
                          f.write("\n")

                      # Also write a copy at the repository subpath for compatibility
                      repo_dir = output_dir / "repository"
                      repo_dir.mkdir(exist_ok=True)
                      repo_index_path = repo_dir / "index.json"
                      with open(repo_index_path, "w", encoding="utf-8") as f:
                          json.dump(index, f, indent=2, ensure_ascii=False)
                          f.write("\n")

                      print(f"\nGenerated index.json with {len(plugins)} plugin(s)")
                      print(f"  -> {index_path}")
                      print(f"  -> {repo_index_path}")

                      # Pretty-print the result
                      print("\n--- index.json ---")
                      print(json.dumps(index, indent=2))


                  if __name__ == "__main__":
                      main()
                  PYEOF

            - name: Upload Pages artifact
              uses: actions/upload-pages-artifact@v3
              with:
                  path: _site

    deploy:
        name: Deploy to GitHub Pages
        needs: build-index
        runs-on: ubuntu-latest

        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}

        steps:
            - name: Deploy to GitHub Pages
              id: deployment
              uses: actions/deploy-pages@v4
